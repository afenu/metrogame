<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paris Metro Master - RATP Live Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --paris-blue: #003ca6; --success: #2ecc71; --error: #e74c3c; --bg: #f4f4f9; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; overflow: hidden; background: var(--bg); }

        /* Banner Feedback in alto */
        #top-banner {
            position: fixed; top: 0; left: 0; width: 100%; height: 45px;
            z-index: 3000; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; transform: translateY(-100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); text-align: center;
        }
        #top-banner.show { transform: translateY(0); }

        #map { height: 100vh; width: 100vw; z-index: 1; }

        /* UI Layer */
        #ui-layer {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 95%; max-width: 450px;
        }
        .mini-card {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            text-align: center; border: 1px solid rgba(255,255,255,0.3);
        }

        /* Menu Linee */
        .line-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin: 10px 0; max-height: 200px; overflow-y: auto; padding: 5px; }
        .line-btn { 
            border: none; padding: 8px; border-radius: 6px; cursor: pointer; 
            color: white; font-weight: bold; font-size: 0.85rem; transition: transform 0.1s;
        }
        .line-btn:active { transform: scale(0.95); }
        
        .station-target { color: var(--paris-blue); font-size: 1.4rem; margin: 10px 0; font-weight: bold; min-height: 40px; line-height: 1.2; }
        .btn-action { background: var(--paris-blue); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 1rem; font-weight: bold; }
        
        .hidden { display: none !important; }
        #loader { font-size: 0.9rem; color: #666; padding: 20px; }
    </style>
</head>
<body>

<div id="top-banner"></div>
<div id="map"></div>

<div id="ui-layer">
    <div id="game-ui" class="mini-card">
        <div id="loader">Caricamento dati RATP in corso...</div>

        <div id="selection-mode" class="hidden">
            <p style="margin:0 0 10px 0; font-weight: bold;">Seleziona una linea:</p>
            <div id="line-buttons" class="line-grid"></div>
            <button class="line-btn" style="background:#333; width:100%; margin-top:5px;" onclick="selectLine('all')">TUTTE LE LINEE</button>
        </div>

        <div id="study-mode" class="hidden">
            <p id="study-info" style="font-size:0.85rem; margin-bottom:12px; color: #444;"></p>
            <button class="btn-action" onclick="startGame()">INIZIA IL QUIZ</button>
        </div>

        <div id="play-mode" class="hidden">
            <div id="game-counter" style="font-size:0.75rem; color:#666; font-weight: bold;"></div>
            <div style="font-size: 0.7rem; color: #999; margin-top:5px; text-transform: uppercase;">Trova la stazione:</div>
            <div id="current-task" class="station-target">---</div>
            <button class="line-btn" style="background:#666; width:100%;" onclick="location.reload()">TORNA AL MENU</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const RATP_API = "https://data.ratp.fr/api/explore/v2.1/catalog/datasets/emplacements-des-stations-ratp/exports/json";
    
    const lineColors = {
        '1': '#FFBE00', '2': '#0055C8', '3': '#BE8043', '3b': '#98D4E2',
        '4': '#B060A0', '5': '#F28E42', '6': '#73CD4B', '7': '#F3A4BA',
        '7b': '#73CD4B', '8': '#C5A3CA', '9': '#D5C900', '10': '#E3B32A',
        '11': '#8D5E2A', '12': '#00814F', '13': '#98D4E2', '14': '#62259D'
    };

    let metroData = {};
    let map, targetStation, isGaming = false;
    let quizPool = [];
    let markerMap = new Map();

    // Inizializza Mappa
    map = L.map('map', { zoomControl: false }).setView([48.8566, 2.3522], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    // 1. Caricamento Dati
    async function init() {
    const loader = document.getElementById('loader');
    try {
        // Tentativo con l'API ufficiale
        const response = await fetch(RATP_API);
        
        if (!response.ok) throw new Error("Risposta server non valida");
        
        const json = await response.json();
        const results = json.results || json; // Gestisce diversi formati di API

        results.forEach(item => {
            if (item.reseau === 'METRO' || item.res_com === 'Metro') {
                const line = item.line || item.route_short_name;
                const name = item.nom_gare || item.stop_name;
                const coords = item.coordinates || { lat: item.stop_lat, lon: item.stop_lon };

                if (!metroData[line]) {
                    metroData[line] = { color: lineColors[line] || '#333', stations: [] };
                }
                
                if (!metroData[line].stations.find(s => s.n === name)) {
                    metroData[line].stations.push({
                        n: name,
                        lat: coords.lat,
                        lng: coords.lon,
                        line: line
                    });
                }
            }
        });

        if (Object.keys(metroData).length === 0) throw new Error("Dati vuoti");

        buildMenu();
        loader.classList.add('hidden');
        document.getElementById('selection-mode').classList.remove('hidden');

    } catch (e) {
        console.error("Dettaglio Errore:", e);
        loader.innerHTML = `
            <p style="color:red">Errore di connessione all'API RATP.</p>
            <button class="btn-action" onclick="loadBackupData()">Usa Dati Locali (Modalit√† Offline)</button>
        `;
    }
}

// Funzione di emergenza se l'API fallisce
function loadBackupData() {
    metroData = {
        '1': { color: '#FFBE00', stations: [{n:"Ch√¢telet", lat:48.858, lng:2.347}, {n:"Bastille", lat:48.853, lng:2.369}, {n:"Nation", lat:48.848, lng:2.395}]},
        '14': { color: '#62259D', stations: [{n:"Saint-Lazare", lat:48.876, lng:2.325}, {n:"Olympiades", lat:48.822, lng:2.366}]}
    };
    buildMenu();
    document.getElementById('loader').classList.add('hidden');
    document.getElementById('selection-mode').classList.remove('hidden');
}
    // 2. Costruzione Menu
    function buildMenu() {
        const container = document.getElementById('line-buttons');
        // Ordina le linee numericamente
        const sortedLines = Object.keys(metroData).sort((a,b) => parseInt(a) - parseInt(b));
        
        sortedLines.forEach(line => {
            const btn = document.createElement('button');
            btn.className = 'line-btn';
            btn.style.backgroundColor = metroData[line].color;
            btn.innerText = line;
            btn.onclick = () => selectLine(line);
            container.appendChild(btn);
        });
    }

    // 3. Selezione Linea
    function selectLine(lineKey) {
        markerMap.forEach(m => map.removeLayer(m));
        markerMap.clear();
        quizPool = [];

        const linesToDraw = lineKey === 'all' ? Object.keys(metroData) : [lineKey];
        
        linesToDraw.forEach(key => {
            const line = metroData[key];
            line.stations.forEach(stazione => {
                if (!markerMap.has(stazione.n)) {
                    quizPool.push({...stazione, color: line.color});
                    
                    let m = L.circleMarker([stazione.lat, stazione.lng], {
                        radius: 7, fillColor: "white", color: "#444", weight: 2, fillOpacity: 1
                    }).addTo(map);

                    m.bindTooltip(stazione.n, { className: 'study-tooltip' });
                    m.on('click', () => { if(isGaming) verify(stazione.n); });
                    markerMap.set(stazione.n, m);
                }
            });
        });

        document.getElementById('selection-mode').classList.add('hidden');
        document.getElementById('study-mode').classList.remove('hidden');
        document.getElementById('study-info').innerText = lineKey === 'all' 
            ? "Tutta la rete caricata. Studia i tondini bianchi!" 
            : `Linea ${lineKey} caricata. Studia le fermate prima di iniziare.`;

        if(lineKey !== 'all') {
            const group = new L.featureGroup(Array.from(markerMap.values()));
            map.fitBounds(group.getBounds().pad(0.2));
        }
    }

    // 4. Inizio Gioco
    function startGame() {
        isGaming = true;
        document.getElementById('study-mode').classList.add('hidden');
        document.getElementById('play-mode').classList.remove('hidden');
        
        quizPool.sort(() => Math.random() - 0.5);
        markerMap.forEach(m => m.unbindTooltip());
        
        updateCounter();
        nextQuestion();
    }

    function nextQuestion() {
        if (quizPool.length === 0) {
            document.getElementById('current-task').innerText = "COMPLETATO! üèÜ";
            return;
        }
        targetStation = quizPool[0];
        document.getElementById('current-task').innerText = targetStation.n;
    }

    // 5. Verifica e Colorazione
    function verify(clickedName) {
        if (clickedName === targetStation.n) {
            const bannerMsg = `‚úÖ ESATTO: ${clickedName}`;
            showFeedback(bannerMsg, "var(--success)");
            
            const m = markerMap.get(clickedName);
            m.setStyle({ 
                fillColor: targetStation.color, 
                color: "white", 
                weight: 1.5, 
                radius: 9 
            });
            m.off('click');
            m.bindTooltip(clickedName); // Riattiva il nome per quelle indovinate

            quizPool.shift();
            updateCounter();
            nextQuestion();
        } else {
            showFeedback(`‚ùå NO, QUESTA √à: ${clickedName}`, "var(--error)");
        }
    }

    function updateCounter() {
        document.getElementById('game-counter').innerText = `STAZIONI RIMANENTI: ${quizPool.length}`;
    }

    function showFeedback(msg, color) {
        const banner = document.getElementById('top-banner');
        banner.innerText = msg;
        banner.style.backgroundColor = color;
        banner.classList.add('show');
        setTimeout(() => banner.classList.remove('show'), 1500);
    }

    init();
</script>
</body>
</html>
